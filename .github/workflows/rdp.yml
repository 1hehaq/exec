name: SSH Access with GUI

on: workflow_dispatch

jobs:
  ssh-access:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare System and Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xfce4 \
            xfce4-terminal \
            tightvncserver \
            novnc \
            websockify \
            jq \
            curl

      - name: Setup VNC Server
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          cat > ~/.vnc/xstartup << EOL
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOL
          chmod +x ~/.vnc/xstartup

          vncserver :1 -geometry 1280x720 -depth 24

      - name: Setup noVNC and Websockify
        run: |
          /usr/share/novnc/utils/launch.sh --listen 6080 --vnc localhost:5901 &

      - name: Setup SSH and Tmate
        id: tmate-setup
        run: |
          sudo apt-get update
          sudo apt-get install -y tmate openssh-client

          ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa

          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready

          SSH_CMD=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          WEB_URL=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')

          escape_markdown() {
            echo "$1" | sed 's/[_\\.+?(){}^$|[\]]/\\&/g'
          }

          ESCAPED_SSH_CMD=$(escape_markdown "$SSH_CMD")
          ESCAPED_WEB_URL=$(escape_markdown "$WEB_URL")

          MSG="🔐 *SSH Access Details*%0A%0A"
          MSG+="*SSH Command:* \`$ESCAPED_SSH_CMD\`%0A"
          MSG+="*Web URL:* \`$ESCAPED_WEB_URL\`%0A%0A"
          MSG+="*Browser-based VNC:* Connect to port 6080 using the SSH session%0A"
          MSG+="*Note:* Session will remain active for 1 hour"

          ENCODED_MSG=$(printf '%s' "$MSG" | jq -sRr @uri)

          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$ENCODED_MSG" \
            -d "parse_mode=MarkdownV2"

      - name: Keep Workflow Alive
        run: |
          echo "Session is now active. You can connect via SSH or VNC."
          sleep 1h
